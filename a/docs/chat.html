<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<h3 id="me"></h3>
<button onclick="logout()">ğŸšª Logout</button>
<hr>

<select id="receiver"></select>

<br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<div id="chat"></div>
<p id="typing" style="font-style:italic;color:gray;"></p>

<script src="/socket.io/socket.io.js"></script>
<script>
  const API = "https://bappa-s-web.onrender.com"; // local à¦¹à¦²à§‡ http://localhost:3000
  const socket = io(API);

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName");

  if (!userId || !userName) {
    alert("Please login first");
    location.href = "/";
  }

  document.getElementById("me").innerText = "You: " + userName;

  const receiverSelect = document.getElementById("receiver");
  const chat = document.getElementById("chat");
  const msgInput = document.getElementById("msg");
  const typingEl = document.getElementById("typing");

  let typingTimeout;
  let ONLINE = [];

  // register online
  socket.emit("addUser", userId);
  socket.emit("getOnlineUsers");

  // ğŸ”¹ TYPING SEND
  msgInput.addEventListener("input", () => {
    const receiverId = receiverSelect.value;
    if (!receiverId) return;

    socket.emit("typing", {
      senderName: userName,
      receiverId
    });

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      socket.emit("stopTyping", { receiverId });
    }, 1000);
  });

  // ğŸ”¹ RECEIVE ONLINE USERS
  socket.on("onlineUsers", (list) => {
    ONLINE = list;
    loadUsers();
  });

  // ğŸ”¹ LOAD USERS
  async function loadUsers() {
    const res = await fetch(API + "/users?me=" + userId);
    const users = await res.json();

    receiverSelect.innerHTML = "";

    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u._id;
      const status = ONLINE.includes(u._id) ? "ğŸŸ¢" : "âšª";
      opt.textContent = `${status} ${u.name}`;
      receiverSelect.appendChild(opt);
    });

    if (receiverSelect.value) {
      loadHistory(receiverSelect.value);
    }
  }

  // ğŸ”¹ LOAD CHAT HISTORY
  async function loadHistory(receiverId) {
    typingEl.innerText = ""; // â­ clear typing on switch

    const res = await fetch(API + "/chat/" + userId + "/" + receiverId);
    const msgs = await res.json();

    chat.innerHTML = "";
    msgs.forEach(m => {
      if (m.senderId === userId) {
        const tick =
          m.status === "seen" ? "âœ”âœ”" :
          m.status === "delivered" ? "âœ”" : "";
        chat.innerHTML += `<p><b>You:</b> ${m.text} ${tick}</p>`;
      } else {
        chat.innerHTML += `<p><b>Them:</b> ${m.text}</p>`;
      }
    });
  }

  receiverSelect.onchange = () => {
    loadHistory(receiverSelect.value);
  };

  // ğŸ”¹ SEND MESSAGE
  function send() {
    const receiverId = receiverSelect.value;
    const text = msgInput.value;
    if (!text) return;

    socket.emit("sendMessage", {
      senderId: userId,
      senderName: userName,
      receiverId,
      text
    });

    // â­ stop typing immediately after send
    socket.emit("stopTyping", { receiverId });
    typingEl.innerText = "";

    chat.innerHTML += `<p><b>You:</b> ${text}</p>`;
    msgInput.value = "";
  }

  // ğŸ”¹ RECEIVE MESSAGE
  socket.on("getMessage", (data) => {
    typingEl.innerText = ""; // â­ clear typing on receive
    chat.innerHTML += `<p><b>${data.senderName}:</b> ${data.text}</p>`;
  });

  // ğŸ”¹ RECEIVE TYPING
  socket.on("typing", (data) => {
    typingEl.innerText = `${data.senderName} is typing...`;
  });

  socket.on("stopTyping", () => {
    typingEl.innerText = "";
  });

  // init
  loadUsers();

  function logout() {
    socket.disconnect(); // ğŸ”Œ socket off
    localStorage.clear();
    location.href = "/";
  }
</script>

</body>
</html>
