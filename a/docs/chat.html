<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<button onclick="location.href='wallet.html'">ğŸ’³ Recharge Wallet</button>

<h3 id="me"></h3>
<p id="wallet">ğŸ’° Wallet: --</p>
<button onclick="logout()">ğŸšª Logout</button>
<hr>

<select id="receiver"></select><br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<button onclick="startCall()">ğŸ“ Call</button>
<button onclick="endCall()">âŒ End Call</button>

<p id="callStatus" style="font-weight:bold;color:green;"></p>
<p id="callTimer"></p>
<p id="callCost" style="color:red;font-weight:bold;"></p>

<hr>

<div id="chat"></div>

<audio id="remoteAudio" autoplay></audio>
<audio id="ringtone" loop>
  <source src="ringtone.mp3" type="audio/mpeg">
</audio>

<p id="typing" style="font-style:italic;color:gray;"></p>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ================= CONFIG ================= */
const API = "https://bappa-s-web.onrender.com";
const RATE_PER_MIN = 5;

/* ================= BASIC ================= */
const socket = io(API);
const userId = localStorage.getItem("userId");
const userName = localStorage.getItem("userName");

if (!userId || !userName) {
  alert("Please login first");
  location.href = "/";
}

document.getElementById("me").innerText = "You: " + userName;

const receiverSelect = document.getElementById("receiver");
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const typingEl = document.getElementById("typing");
const callStatus = document.getElementById("callStatus");
const callTimerEl = document.getElementById("callTimer");
const callCostEl = document.getElementById("callCost");
const remoteAudio = document.getElementById("remoteAudio");
const ringtone = document.getElementById("ringtone");
const walletEl = document.getElementById("wallet");

/* ================= STATE ================= */
let CALL_STATE = "IDLE";
let callStartTime = null;
let callTimer = null;
let pc = null;
let localStream = null;

/* ================= WALLET ================= */
async function loadWallet(){
  const r = await fetch(API + "/users/wallet/" + userId);
  const d = await r.json();
  walletEl.innerText = "ğŸ’° Wallet: â‚¹" + d.wallet;
}

/* ================= USERS ================= */
let ONLINE = [];
socket.emit("addUser", userId);
socket.emit("getOnlineUsers");

socket.on("onlineUsers", list=>{
  ONLINE = list;
  loadUsers();
});

async function loadUsers(){
  const r = await fetch(API + "/users?me=" + userId);
  const users = await r.json();
  receiverSelect.innerHTML = "";

  users.forEach(u=>{
    const o = document.createElement("option");
    o.value = u._id;
    o.textContent = `${ONLINE.includes(u._id) ? "ğŸŸ¢" : "âšª"} ${u.name}`;
    receiverSelect.appendChild(o);
  });
}

/* ================= CHAT ================= */
async function loadHistory(id){
  chat.innerHTML = "";
  const r = await fetch(API + "/chat/" + userId + "/" + id);
  const msgs = await r.json();

  msgs.forEach(m=>{
    chat.innerHTML += m.senderId === userId
      ? `<p><b>You:</b> ${m.text}</p>`
      : `<p><b>Them:</b> ${m.text}</p>`;
  });
}

receiverSelect.onchange = ()=>loadHistory(receiverSelect.value);

function send(){
  if(!msgInput.value) return;
  socket.emit("sendMessage",{
    senderId:userId,
    senderName:userName,
    receiverId:receiverSelect.value,
    text:msgInput.value
  });
  chat.innerHTML += `<p><b>You:</b> ${msgInput.value}</p>`;
  msgInput.value="";
}

/* ================= TYPING ================= */
let tmo;
msgInput.addEventListener("input",()=>{
  socket.emit("typing",{senderName:userName,receiverId:receiverSelect.value});
  clearTimeout(tmo);
  tmo=setTimeout(()=>socket.emit("stopTyping",{receiverId:receiverSelect.value}),1000);
});
socket.on("typing",d=>typingEl.innerText=d.senderName+" is typing...");
socket.on("stopTyping",()=>typingEl.innerText="");

/* ================= TIMER ================= */
function startTimer(){
  callStartTime = Date.now();
  callTimer = setInterval(()=>{
    const s = Math.floor((Date.now()-callStartTime)/1000);
    callTimerEl.innerText = `â± ${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")}`;
  },1000);
}
function stopTimer(){
  clearInterval(callTimer);
  callTimer=null;
  callTimerEl.innerText="";
}

/* ================= WEBRTC ================= */
async function initRTC(){
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  pc.onicecandidate=e=>{
    if(e.candidate) socket.emit("webrtc-ice",{to:receiverSelect.value,candidate:e.candidate});
  };
  pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

/* ================= CALL ================= */
async function startCall(){
  const r = await fetch(API+"/users/wallet/"+userId);
  const d = await r.json();
  if(d.wallet < RATE_PER_MIN) return alert("âŒ Insufficient balance");

  CALL_STATE="CALLING";
  callStatus.innerText="Calling...";
  socket.emit("callUser",{callerId:userId,callerName:userName,receiverId:receiverSelect.value});
}

socket.on("incomingCall",async d=>{
  ringtone.play();
  const ok = confirm(`ğŸ“ ${d.callerName} is calling`);
  ringtone.pause(); ringtone.currentTime=0;
  if(!ok) return socket.emit("rejectCall",{callerId:d.callerId});
  await initRTC();
  socket.emit("acceptCall",{callerId:d.callerId});
  CALL_STATE="CONNECTED";
  callStatus.innerText="Call connected";
  startTimer();
});

socket.on("callAccepted",async ()=>{
  await initRTC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("webrtc-offer",{to:receiverSelect.value,offer});
  CALL_STATE="CONNECTED";
  callStatus.innerText="Call connected";
  startTimer();
});

socket.on("webrtc-offer",async offer=>{
  await initRTC();
  await pc.setRemoteDescription(offer);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("webrtc-answer",{to:receiverSelect.value,answer:ans});
});
socket.on("webrtc-answer",a=>pc.setRemoteDescription(a));
socket.on("webrtc-ice",c=>c&&pc.addIceCandidate(c));

/* ================= END CALL ================= */
function endCall(){
  if(!callStartTime) return;

  const mins = Math.ceil((Date.now()-callStartTime)/60000);
  const cost = mins*RATE_PER_MIN;

  fetch(API+"/users/wallet/deduct",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId,amount:cost})
  }).then(()=>loadWallet());

  stopTimer();
  callCostEl.innerText=`Debited â‚¹${cost}`;
  callStatus.innerText="Call ended";
  CALL_STATE="IDLE";

  if(pc){pc.close();pc=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}

  socket.emit("endCall",{otherUserId:receiverSelect.value});
}

socket.on("callEnded",endCall);

/* ================= LOGOUT ================= */
function logout(){
  endCall();
  socket.disconnect();
  localStorage.clear();
  location.href="/";
}

loadUsers();
loadWallet();
</script>
</body>
</html>
