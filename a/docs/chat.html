<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<h3 id="me"></h3>

<select id="receiver"></select>

<br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const API = "https://bappa-s-web.onrender.com"; // Render URL
  const socket = io(API);

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName");

  if (!userId) {
    alert("Please login first");
    location.href = "/";
  }

  // show my name
  document.getElementById("me").innerText = "You: " + userName;

  // register online
  socket.emit("addUser", userId);

  // ðŸ”¥ LOAD USERS FROM DB
  async function loadUsers() {
    const res = await fetch(API + "/users?me=" + userId);
    const users = await res.json();

    const receiver = document.getElementById("receiver");
    receiver.innerHTML = "";

    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u._id;
      opt.textContent = u.name;
      receiver.appendChild(opt);
    });
  }

  loadUsers();

  function send() {
    const receiverId = receiver.value;
    const text = msg.value;
    if (!text) return;

    socket.emit("sendMessage", {
      senderId: userId,
      receiverId,
      text
    });

    chat.innerHTML += `<p><b>You:</b> ${text}</p>`;
    msg.value = "";
  }

  socket.on("getMessage", (data) => {
    chat.innerHTML += `<p><b>Them:</b> ${data.text}</p>`;
  });
</script>

</body>
</html>
