<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<h3 id="me"></h3>
<button onclick="logout()">ğŸšª Logout</button>
<hr>

<select id="receiver"></select>

<br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<button onclick="startCall()">ğŸ“ Call</button>
<button onclick="endCall()">âŒ End Call</button>

<p id="callStatus" style="font-weight:bold;color:green;"></p>
<p id="callTimer" style="font-weight:bold;color:#444;"></p>

<hr>

<div id="chat"></div>
<audio id="remoteAudio" autoplay></audio>

<!-- ğŸ”” RINGTONE -->
<audio id="ringtone" loop preload="auto">
  <source src="ringtone.mp3" type="audio/mpeg">
</audio>

<p id="typing" style="font-style:italic;color:gray;"></p>

<script src="/socket.io/socket.io.js"></script>
<script>
  const API = "https://bappa-s-web.onrender.com";
  const socket = io(API);

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName");

  if (!userId || !userName) {
    alert("Please login first");
    location.href = "/";
  }

  document.getElementById("me").innerText = "You: " + userName;

  const receiverSelect = document.getElementById("receiver");
  const chat = document.getElementById("chat");
  const msgInput = document.getElementById("msg");
  const typingEl = document.getElementById("typing");
  const callStatus = document.getElementById("callStatus");
  const callTimerEl = document.getElementById("callTimer");
  const remoteAudio = document.getElementById("remoteAudio");
  const ringtone = document.getElementById("ringtone");

  let typingTimeout;
  let ONLINE = [];
  let CALL_ACTIVE = false;
  let callInterval = null;
  let callStartTime = null;

  // =========================
  // â± CALL TIMER
  // =========================
  function startCallTimer() {
    callStartTime = Date.now();
    callInterval = setInterval(() => {
      const diff = Date.now() - callStartTime;
      const sec = Math.floor(diff / 1000);
      const min = Math.floor(sec / 60);
      const s = sec % 60;
      callTimerEl.innerText =
        `â± Call time: ${String(min).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }, 1000);
  }

  function stopCallTimer() {
    clearInterval(callInterval);
    callInterval = null;
    callTimerEl.innerText = "";
  }

  // =========================
  // ğŸ”Œ ONLINE
  // =========================
  socket.emit("addUser", userId);
  socket.emit("getOnlineUsers");

  socket.on("onlineUsers", (list) => {
    ONLINE = list;
    loadUsers();
  });

  async function loadUsers() {
    const res = await fetch(API + "/users?me=" + userId);
    const users = await res.json();

    receiverSelect.innerHTML = "";
    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u._id;
      opt.textContent = `${ONLINE.includes(u._id) ? "ğŸŸ¢" : "âšª"} ${u.name}`;
      receiverSelect.appendChild(opt);
    });
  }

  // =========================
  // ğŸ’¬ CHAT
  // =========================
  async function loadHistory(receiverId) {
    const res = await fetch(API + "/chat/" + userId + "/" + receiverId);
    const msgs = await res.json();
    chat.innerHTML = "";
    msgs.forEach(m => {
      chat.innerHTML += `<p><b>${m.senderId === userId ? "You" : "Them"}:</b> ${m.text}</p>`;
    });
  }

  receiverSelect.onchange = () => loadHistory(receiverSelect.value);

  function send() {
    const text = msgInput.value;
    if (!text) return;

    socket.emit("sendMessage", {
      senderId: userId,
      senderName: userName,
      receiverId: receiverSelect.value,
      text
    });

    chat.innerHTML += `<p><b>You:</b> ${text}</p>`;
    msgInput.value = "";
  }

  socket.on("getMessage", (data) => {
    chat.innerHTML += `<p><b>${data.senderName}:</b> ${data.text}</p>`;
  });

  // =========================
  // ğŸ“ CALL + RINGTONE
  // =========================
  let pc, localStream;

  async function startCall() {
    callStatus.innerText = "Calling...";
    socket.emit("callUser", {
      callerId: userId,
      callerName: userName,
      receiverId: receiverSelect.value
    });
  }

  socket.on("incomingCall", async (data) => {
    try { await ringtone.play(); } catch(e){}
    const ok = confirm(`ğŸ“ ${data.callerName} is calling. Accept?`);
    ringtone.pause(); ringtone.currentTime = 0;

    if (!ok) {
      socket.emit("rejectCall", { callerId: data.callerId });
      return;
    }

    CALL_ACTIVE = true;
    callStatus.innerText = "Call connected";
    startCallTimer();
  });

  socket.on("callAccepted", () => {
    ringtone.pause(); ringtone.currentTime = 0;
    CALL_ACTIVE = true;
    callStatus.innerText = "Call connected";
    startCallTimer();
  });

  socket.on("callRejected", () => {
    ringtone.pause(); ringtone.currentTime = 0;
    callStatus.innerText = "Call rejected";
  });

  function endCall() {
    ringtone.pause(); ringtone.currentTime = 0;
    CALL_ACTIVE = false;
    stopCallTimer();
    socket.emit("endCall", { otherUserId: receiverSelect.value });
    callStatus.innerText = "Call ended";
  }

  socket.on("callEnded", () => {
    ringtone.pause(); ringtone.currentTime = 0;
    CALL_ACTIVE = false;
    stopCallTimer();
    callStatus.innerText = "Call ended";
  });

  function logout() {
    if (CALL_ACTIVE) {
      alert("End call first");
      return;
    }
    ringtone.pause(); ringtone.currentTime = 0;
    socket.disconnect();
    localStorage.clear();
    location.href = "/";
  }
</script>

</body>
</html>
