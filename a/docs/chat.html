<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<h3 id="me"></h3>
<button onclick="logout()">ğŸšª Logout</button>
<hr>

<select id="receiver"></select><br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<button onclick="startCall()">ğŸ“ Call</button>
<button onclick="endCall()">âŒ End Call</button>

<p id="callStatus" style="font-weight:bold;color:green;"></p>
<p id="callTimer"></p>
<p id="callCost" style="color:red;font-weight:bold;"></p>

<hr>

<div id="chat"></div>

<audio id="remoteAudio" autoplay></audio>
<audio id="ringtone" loop>
  <source src="ringtone.mp3" type="audio/mpeg">
</audio>

<p id="typing" style="font-style:italic;color:gray;"></p>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ================= BASIC ================= */
const API = "https://bappa-s-web.onrender.com";
const socket = io(API);

const userId = localStorage.getItem("userId");
const userName = localStorage.getItem("userName");

if (!userId || !userName) {
  alert("Please login first");
  location.href = "/";
}

document.getElementById("me").innerText = "You: " + userName;

const receiverSelect = document.getElementById("receiver");
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const typingEl = document.getElementById("typing");
const callStatus = document.getElementById("callStatus");
const callTimerEl = document.getElementById("callTimer");
const callCostEl = document.getElementById("callCost");
const remoteAudio = document.getElementById("remoteAudio");
const ringtone = document.getElementById("ringtone");

/* ================= ONLINE ================= */
let ONLINE = [];
socket.emit("addUser", userId);
socket.emit("getOnlineUsers");

socket.on("onlineUsers", list => {
  ONLINE = list;
  loadUsers();
});

async function loadUsers(){
  const res = await fetch(API + "/users?me=" + userId);
  const users = await res.json();
  receiverSelect.innerHTML = "";

  users.forEach(u=>{
    const opt = document.createElement("option");
    opt.value = u._id;
    opt.textContent = `${ONLINE.includes(u._id) ? "ğŸŸ¢" : "âšª"} ${u.name}`;
    receiverSelect.appendChild(opt);
  });

  if(receiverSelect.value) loadHistory(receiverSelect.value);
}

/* ================= CHAT ================= */
async function loadHistory(rid){
  chat.innerHTML = "";
  typingEl.innerText = "";
  const res = await fetch(API + "/chat/" + userId + "/" + rid);
  const msgs = await res.json();
  msgs.forEach(m=>{
    chat.innerHTML += m.senderId === userId
      ? `<p><b>You:</b> ${m.text}</p>`
      : `<p><b>Them:</b> ${m.text}</p>`;
  });
}

receiverSelect.onchange = ()=> loadHistory(receiverSelect.value);

function send(){
  const text = msgInput.value;
  const rid = receiverSelect.value;
  if(!text) return;

  socket.emit("sendMessage",{
    senderId:userId,
    senderName:userName,
    receiverId:rid,
    text
  });

  chat.innerHTML += `<p><b>You:</b> ${text}</p>`;
  msgInput.value="";
}

/* ================= TYPING ================= */
let typingTimeout;
msgInput.addEventListener("input",()=>{
  const rid = receiverSelect.value;
  socket.emit("typing",{ senderName:userName, receiverId:rid });
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{
    socket.emit("stopTyping",{ receiverId:rid });
  },1000);
});

socket.on("typing",d=> typingEl.innerText=`${d.senderName} is typing...`);
socket.on("stopTyping",()=> typingEl.innerText="");

/* ================= WEBRTC ================= */
let pc, localStream;
const RTC_CONFIG = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

async function initWebRTC(){
  pc = new RTCPeerConnection(RTC_CONFIG);

  pc.onicecandidate = e=>{
    if(e.candidate){
      socket.emit("webrtc-ice",{ to:receiverSelect.value, candidate:e.candidate });
    }
  };

  pc.ontrack = e=> remoteAudio.srcObject = e.streams[0];

  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

/* ================= CALL + BILLING ================= */
const RATE = 5;
let callStartTime = null;
let timerInt = null;

function startTimer(){
  callStartTime = Date.now();
  timerInt = setInterval(()=>{
    const s = Math.floor((Date.now()-callStartTime)/1000);
    callTimerEl.innerText = `â± ${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")}`;
  },1000);
}

function stopTimer(){
  clearInterval(timerInt);
  timerInt=null;
}

async function startCall(){
  callStatus.innerText="Calling...";
  socket.emit("callUser",{
    callerId:userId,
    callerName:userName,
    receiverId:receiverSelect.value
  });
}

socket.on("incomingCall",async d=>{
  ringtone.play();
  const ok = confirm(`ğŸ“ ${d.callerName} is calling`);
  ringtone.pause(); ringtone.currentTime=0;

  if(!ok){
    socket.emit("rejectCall",{ callerId:d.callerId });
    return;
  }

  socket.emit("acceptCall",{ callerId:d.callerId });
  callStatus.innerText="Call connected";
  startTimer();
});

socket.on("callAccepted",async ()=>{
  await initWebRTC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("webrtc-offer",{ to:receiverSelect.value, offer });
  callStatus.innerText="Call connected";
  startTimer();
});

socket.on("webrtc-offer",async offer=>{
  await initWebRTC();
  await pc.setRemoteDescription(offer);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("webrtc-answer",{ to:receiverSelect.value, answer:ans });
});

socket.on("webrtc-answer",a=> pc.setRemoteDescription(a));
socket.on("webrtc-ice",c=> c && pc.addIceCandidate(c));

function endCall(){
  stopTimer();

  const mins = Math.ceil((Date.now()-callStartTime)/60000);
  const cost = mins * RATE;
  callCostEl.innerText = `ğŸ’¸ Debited â‚¹${cost} (${mins} min Ã— â‚¹${RATE})`;

  socket.emit("endCall",{ otherUserId:receiverSelect.value });

  if(pc) pc.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
}

socket.on("callEnded",()=>{
  stopTimer();
  callStatus.innerText="Call ended";
});

/* ================= LOGOUT ================= */
function logout(){
  socket.disconnect();
  localStorage.clear();
  location.href="/";
}

loadUsers();
</script>
</body>
</html>
