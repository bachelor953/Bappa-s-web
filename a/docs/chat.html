<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
</head>
<body>

<h3 id="me"></h3>

<select id="receiver"></select>

<br><br>

<input id="msg" placeholder="Type message">
<button onclick="send()">Send</button>

<hr>

<div id="chat"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const API = "https://bappa-s-web.onrender.com"; // local à¦¹à¦²à§‡ http://localhost:3000
  const socket = io(API);

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName");

  if (!userId || !userName) {
    alert("Please login first");
    location.href = "/";
  }

  // show my name
  document.getElementById("me").innerText = "You: " + userName;

  const receiverSelect = document.getElementById("receiver");
  const chat = document.getElementById("chat");
  const msgInput = document.getElementById("msg");

  // ðŸ”¹ ONLINE USERS LIST
  let ONLINE = [];

  // register online
  socket.emit("addUser", userId);

  // ask server who is online
  socket.emit("getOnlineUsers");

  // receive online users list
  socket.on("onlineUsers", (list) => {
    ONLINE = list;
    loadUsers(); // re-render dropdown with status
  });

  // ðŸ”¹ LOAD USERS FROM DB
  async function loadUsers() {
    const res = await fetch(API + "/users?me=" + userId);
    const users = await res.json();

    receiverSelect.innerHTML = "";

    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u._id;

      // ðŸŸ¢ online / âšª offline
      const status = ONLINE.includes(u._id) ? "ðŸŸ¢" : "âšª";
      opt.textContent = `${status} ${u.name}`;

      receiverSelect.appendChild(opt);
    });

    // load history with first user
    if (receiverSelect.value) {
      loadHistory(receiverSelect.value);
    }
  }

  // ðŸ”¹ LOAD CHAT HISTORY
  async function loadHistory(receiverId) {
    const res = await fetch(API + "/chat/" + userId + "/" + receiverId);
    const msgs = await res.json();

    chat.innerHTML = "";
    msgs.forEach(m => {
      if (m.senderId === userId) {
        const tick =
  m.status === "seen" ? "âœ”âœ”" :
  m.status === "delivered" ? "âœ”" : "";

chat.innerHTML += `<p><b>You:</b> ${m.text} ${tick}</p>`;
      } else {
        chat.innerHTML += `<p><b>Them:</b> ${m.text}</p>`;
      }
    });
  }

  // receiver change à¦¹à¦²à§‡ history reload
  receiverSelect.onchange = () => {
    loadHistory(receiverSelect.value);
  };

  // SEND MESSAGE
  function send() {
    const receiverId = receiverSelect.value;
    const text = msgInput.value;
    if (!text) return;

    socket.emit("sendMessage", {
      senderId: userId,
      senderName: userName,
      receiverId,
      text
    });

    chat.innerHTML += `<p><b>You:</b> ${text}</p>`;
    msgInput.value = "";
  }

  // RECEIVE LIVE MESSAGE
  socket.on("getMessage", (data) => {
    chat.innerHTML += `<p><b>${data.senderName}:</b> ${data.text}</p>`;
  });

  // init
  loadUsers();
</script>

</body>
</html>
